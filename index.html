<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chat Application</title>
  <style>
    /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šå·¦å´ã«ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä¸€è¦§ã€å³å´ã«ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
    }
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä¸€è¦§ */
    #sidebar {
      width: 250px;
      background: #fff;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      padding: 10px;
    }
    #sidebar h2 {
      margin-top: 0;
      font-size: 1.2em;
    }
    .chatroom-item {
      padding: 10px;
      margin-bottom: 5px;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
    }
    .chatroom-item.active {
      background-color: #e6f7ff;
    }
    /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
    #chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    /* ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ */
    #chat-header {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      background: #fff;
      font-size: 1.1em;
    }
    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #fff;
    }
    .chat-message {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #f9f9f9;
    }
    .message-header {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .message-time {
      color: #777;
      font-size: 0.8em;
      margin-left: 5px;
    }
    .read-receipt {
      margin-top: 5px;
      font-size: 0.8em;
      color: green;
    }
    /* ä¸‹éƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éƒ¨ */
    #chat-controls {
      padding: 10px;
      border-top: 1px solid #ddd;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    #chat-actions {
      margin-bottom: 10px;
    }
    #chat-actions button {
      margin-right: 5px;
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }
    #chat-actions button:hover {
      background: #0056b3;
    }
    #message-form {
      display: flex;
    }
    #message-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    #send-button {
      padding: 10px;
      margin-left: 5px;
      border: none;
      border-radius: 5px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }
    #send-button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <!-- ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä¸€è¦§ -->
  <div id="sidebar">
    <h2>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä¸€è¦§</h2>
    <div id="chatrooms-container"></div>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
  <div id="chat-area">
    <div id="chat-header">ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div id="chat-container"></div>
    <div id="chat-controls">
      <div id="chat-actions">
        <button id="search-button">ğŸ”æ¤œç´¢</button>
        <button id="export-button">ğŸ“„å±¥æ­´ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button id="voice-button">ğŸ¤éŸ³å£°ãƒ¡ãƒ¢</button>
      </div>
      <form id="message-form">
        <input id="message-input" type="text" placeholder="ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›â€¦">
        <button id="send-button" type="submit">é€ä¿¡</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, query, orderBy, where, onSnapshot, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCJl6C4tIPfUIs9GrzRSUMujx2pW9a0RJU",
      authDomain: "chatline-f3c80.firebaseapp.com",
      projectId: "chatline-f3c80",
      storageBucket: "chatline-f3c80.firebasestorage.app",
      messagingSenderId: "285961629279",
      appId: "1:285961629279:web:cf23a01d0f3bb44dd835ea",
      measurementId: "G-Y0HXRRVR66"
    };

    // Firebase åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ç¾åœ¨é¸æŠä¸­ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ IDã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼ã®è§£é™¤ç”¨å¤‰æ•°
    let currentRoomId = null;
    let unsubscribeMessages = null;

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆç¾åœ¨é¸æŠä¸­ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã¸ï¼‰
    async function sendMessage(text) {
      if (!currentRoomId) return;
      try {
        await addDoc(collection(db, "messages"), {
          roomId: currentRoomId,
          user: "åŒ¿å",  // å¿…è¦ã«å¿œã˜ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å–å¾—æ–¹æ³•ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„
          text: text,
          timestamp: serverTimestamp(),
          readBy: []
        });
      } catch (e) {
        console.error("Error adding document: ", e);
      }
    }

    // é¸æŠä¸­ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰
    function loadMessages() {
      if (!currentRoomId) return;
      // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚Œã°è§£é™¤
      if (unsubscribeMessages) {
        unsubscribeMessages();
      }
      const q = query(
        collection(db, "messages"),
        where("roomId", "==", currentRoomId),
        orderBy("timestamp")
      );
      unsubscribeMessages = onSnapshot(q, (snapshot) => {
        const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderChat(messages);
      });
    }

    // ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä¸€è¦§ã®å–å¾—ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰
    function loadChatrooms() {
      const chatroomsContainer = document.getElementById("chatrooms-container");
      const q = query(collection(db, "chatrooms"), orderBy("name"));
      onSnapshot(q, (snapshot) => {
        chatroomsContainer.innerHTML = "";
        snapshot.docs.forEach(doc => {
          const room = { id: doc.id, ...doc.data() };
          const roomElement = document.createElement("div");
          roomElement.classList.add("chatroom-item");
          roomElement.textContent = `${room.icon || ""} ${room.name}`;
          roomElement.addEventListener("click", () => {
            // é¸æŠçŠ¶æ…‹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll(".chatroom-item").forEach(item => item.classList.remove("active"));
            roomElement.classList.add("active");
            currentRoomId = room.id;
            document.getElementById("chat-header").textContent = `${room.icon || ""} ${room.name}`;
            loadMessages();
          });
          chatroomsContainer.appendChild(roomElement);
        });
      });
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderChat(messages) {
      const chatContainer = document.getElementById("chat-container");
      chatContainer.innerHTML = "";
      messages.forEach(msg => {
        const messageElement = document.createElement("div");
        messageElement.classList.add("chat-message");
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®æ•´å½¢ï¼ˆFirestore Timestamp ã‚’ Date ã«å¤‰æ›ï¼‰
        let timeString = "";
        if (msg.timestamp && msg.timestamp.toDate) {
          const date = msg.timestamp.toDate();
          const hours = date.getHours().toString().padStart(2, '0');
          const minutes = date.getMinutes().toString().padStart(2, '0');
          timeString = `${hours}:${minutes}`;
        }
        messageElement.innerHTML = `
          <div class="message-header">ğŸ§‘â€ğŸ’¼ ${msg.user} <span class="message-time">${timeString}</span></div>
          <div class="message-text">${msg.text}</div>
          ${msg.readBy && msg.readBy.length ? `<div class="read-receipt">ğŸŸ¢ æ—¢èª­: ${msg.readBy.join(", ")}</div>` : ""}
        `;
        chatContainer.appendChild(messageElement);
      });
      // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã‚ŒãŸã¨ãã«è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    window.onload = () => {
      loadChatrooms();

      const messageForm = document.getElementById("message-form");
      const messageInput = document.getElementById("message-input");

      messageForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (text && currentRoomId) {
          sendMessage(text);
          messageInput.value = "";
        }
      });

      // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ©Ÿèƒ½ï¼ˆå®Ÿè£…äºˆå®šï¼‰
      document.getElementById("search-button").addEventListener("click", () => {
        alert("æ¤œç´¢æ©Ÿèƒ½ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      });
      document.getElementById("export-button").addEventListener("click", () => {
        alert("å±¥æ­´ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      });
      document.getElementById("voice-button").addEventListener("click", () => {
        alert("éŸ³å£°ãƒ¡ãƒ¢æ©Ÿèƒ½ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      });
    };
  </script>
</body>
</html>
