<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
        }
        #room-container {
            width: 100%;
            background: #fff;
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .chat-room {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: #e6f7ff;
            cursor: pointer;
        }
        .chat-room:hover {
            background: #d0ebff;
        }
        #chat-container {
            width: 100%;
            height: 400px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: #e6f7ff;
        }
        .chat-message strong {
            display: block;
            color: #007bff;
        }
        #controls {
            display: flex;
            gap: 10px;
        }
        #controls input, #controls button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        #controls button {
            background: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        #controls button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Chat Application</h1>
    <div id="room-container"></div>
    <div id="chat-container"></div>
    <div id="controls">
        <input id="user-input" type="text" placeholder="Your name">
        <input id="message-input" type="text" placeholder="Enter message">
        <button id="send-button">Send</button>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Firebase 設定
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Firebase 初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentRoom = null;

        // チャットルームの取得
        function loadRooms(callback) {
            const q = query(collection(db, "rooms"));
            onSnapshot(q, (snapshot) => {
                const rooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                callback(rooms);
            });
        }

        // メッセージの取得（リアルタイム）
        function loadMessages(callback) {
            if (!currentRoom) return;
            const q = query(collection(db, `rooms/${currentRoom}/messages`), orderBy("timestamp"));
            onSnapshot(q, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                callback(messages);
            });
        }

        // メッセージの送信
        async function sendMessage(user, text) {
            if (!currentRoom) return;
            try {
                await addDoc(collection(db, `rooms/${currentRoom}/messages`), {
                    user: user,
                    text: text,
                    timestamp: new Date().toISOString()
                });
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        // UI: チャットルームの表示
        function renderRooms(rooms) {
            const roomContainer = document.getElementById("room-container");
            roomContainer.innerHTML = "";
            rooms.forEach(room => {
                const roomElement = document.createElement("div");
                roomElement.classList.add("chat-room");
                roomElement.innerHTML = room.name;
                roomElement.addEventListener("click", () => {
                    currentRoom = room.id;
                    loadMessages(renderChat);
                });
                roomContainer.appendChild(roomElement);
            });
        }

        // UI: チャットメッセージの表示
        function renderChat(messages) {
            const chatContainer = document.getElementById("chat-container");
            chatContainer.innerHTML = "";
            messages.forEach(msg => {
                const messageElement = document.createElement("div");
                messageElement.classList.add("chat-message");
                messageElement.innerHTML = `<strong>${msg.user}:</strong> ${msg.text}`;
                chatContainer.appendChild(messageElement);
            });
        }

        // イベントリスナー
        window.onload = () => {
            const sendButton = document.getElementById("send-button");
            const messageInput = document.getElementById("message-input");
            const userInput = document.getElementById("user-input");

            loadRooms(renderRooms);

            sendButton.addEventListener("click", () => {
                const text = messageInput.value.trim();
                const user = userInput.value.trim();
                if (text && user) {
                    sendMessage(user, text);
                    messageInput.value = "";
                }
            });
        };
    </script>
</body>
</html>
